<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Methods - SLRailE</title>
    <link rel="stylesheet" href="/templetes/IT24101558/CSS/payment.css">
</head>
<body>
<!-- Header -->
<header class="header">
    <div class="logo-container">
        <div class="train-icon"></div>
        <h1>SLRailE</h1>
    </div>
    <nav class="navigation">
        <ul>
            <li><a href="../../IT24101525/HTML/userprofile.html">My Profile</a></li>
            <li><a href="../../IT24102460/HTML/mem_shedule.html">Schedule</a></li>
            <li><a href="../../IT24101558/HTML/bookinghistory.html">Booking History</a></li>
            <li><a href="../../IT24300073/HTML/notification.html">Notifications</a></li>
            <li><a href="../../IT24101009/HTML/mem-feedback.html">Feedback</a></li>
            <li><a href="../../IT24101525/HTML/usersettings.html">Settings</a></li>
            <li><a href="../../IT24101208/HTML/member-logout.html">Logout</a></li>
        </ul>
    </nav>
</header>

<main class="main-content">
    <!-- Payment Summary -->
    <section class="payment-summary">
        <h2>Payment Summary</h2>
        <div class="summary-row">
            <strong>Train:</strong> <span id="ps-train"></span>
        </div>
        <div class="summary-row">
            <strong>From:</strong> <span id="ps-from"></span>
        </div>
        <div class="summary-row">
            <strong>To:</strong> <span id="ps-to"></span>
        </div>
        <div class="summary-row">
            <strong>Departure:</strong> <span id="ps-dep"></span>
        </div>
        <div class="summary-row">
            <strong>Arrival:</strong> <span id="ps-arr"></span>
        </div>
        <div class="summary-row">
            <strong>Seats:</strong> <span id="ps-seats"></span>
        </div>
        <div class="summary-row">
            <strong>Total Amount:</strong> <span id="total-amount"></span>
        </div>
    </section>

    <!-- Payment Methods Section -->
    <section class="payment-methods-container">
        <div class="title-with-button">
            <h2>Payment Methods</h2>
            <button class="btn add-method">+ Add New Method</button>
        </div>

        <!-- Saved Payment Methods -->
        <div class="saved-methods">
            <h3>Your Saved Payment Methods</h3>
            <div class="methods-grid" id="methods-grid">
                <!-- Payment methods will be dynamically inserted here -->
            </div>
        </div>

        <!-- Add/Edit Payment Method Form (Hidden by default) -->
        <div class="payment-form-container" id="payment-form" style="display: none;">
            <h3 id="form-title">Add New Payment Method</h3>
            <form class="payment-form">
                <input type="hidden" id="payment-method-id">
                <div class="form-group">
                    <label for="card-holder">Card Holder Name</label>
                    <input type="text" id="card-holder" class="form-input" placeholder="Enter full name" required>
                </div>
                <div class="form-group">
                    <label for="card-number">Card Number</label>
                    <input type="text" id="card-number" class="form-input" placeholder="Enter card number" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="expiry-date">Expiry Date (MM/YY)</label>
                        <input type="text" id="expiry-date" class="form-input" placeholder="MM/YY" required>
                    </div>
                    <div class="form-group">
                        <label for="cvv">CVV</label>
                        <input type="text" id="cvv" class="form-input" placeholder="CVV" required>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn cancel-form">Cancel</button>
                    <button type="submit" class="btn save-method">Save Method</button>
                </div>
            </form>
        </div>

        <!-- Payment Action Buttons -->
        <div class="payment-actions">
            <button class="btn cancel-payment">Cancel Payment</button>
            <button class="btn proceed-payment">Proceed to Payment</button>
        </div>
    </section>
</main>

<!-- Footer -->
<footer class="footer">
    <div class="footer-content">
        <div class="footer-logo">
            <h3>SLRailE</h3>
            <p>SLRailE is your all-in-one digital companion for train travel across Sri Lanka. Designed to make journeys smoother and more convenient, SLRailE provides real-time train schedules, route planning, and live updates on arrivals, departures, and delays.</p>
            <p>Whether you're a daily commuter or a tourist exploring the island's breathtaking scenery, SLRailE is your essential partner for smart and seamless railway travel.</p>
        </div>
        <div class="footer-links">
            <div class="link-column">
                <h4>Services</h4>
                <ul>
                    <li><a href="#">Schedule</a></li>
                    <li><a href="#">Tickets</a></li>
                    <li><a href="#">Reservations</a></li>
                    <li><a href="#">Luggage</a></li>
                </ul>
            </div>
            <div class="link-column">
                <h4>Information</h4>
                <ul>
                    <li><a href="#">About Us</a></li>
                    <li><a href="#">Careers</a></li>
                    <li><a href="#">News</a></li>
                    <li><a href="#">Contact</a></li>
                </ul>
            </div>
            <div class="link-column">
                <h4>Legal</h4>
                <ul>
                    <li><a href="#">Privacy Policy</a></li>
                    <li><a href="#">Terms of Service</a></li>
                    <li><a href="#">Cookie Policy</a></li>
                </ul>
            </div>
        </div>
    </div>
    <div class="copyright">
        <p>&copy; 2025 SLRailE. All rights reserved.</p>
    </div>
</footer>

<!-- Script -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const userEmail = localStorage.getItem('slraile_member_email') || 'member@example.com';
        const userId = 1; // TODO: replace when auth wired
        const methodsGrid = document.getElementById('methods-grid');

        // Populate summary from booking
        const qp = new URLSearchParams(window.location.search);
        const bookingId = Number(qp.get('bookingId') || localStorage.getItem('slraile_current_booking_id'));
        const cached = (() => { try { return JSON.parse(localStorage.getItem('slraile_current_booking_summary')); } catch(_) { return null; }})();

        function renderSummary(obj) {
            if (!obj) return;
            document.getElementById('ps-train').textContent = obj.trainName || '';
            document.getElementById('ps-from').textContent = obj.routeFrom || '';
            document.getElementById('ps-to').textContent = obj.routeTo || '';
            document.getElementById('ps-dep').textContent = obj.departureTime || '';
            document.getElementById('ps-arr').textContent = obj.arrivalTime || '';
            document.getElementById('ps-seats').textContent = obj.seatNumbers || '';
            document.getElementById('total-amount').textContent = obj.totalAmount != null ? `Rs. ${Number(obj.totalAmount).toFixed(2)}` : '';
        }

        async function loadBooking() {
            if (!bookingId) return renderSummary(cached);
            try {
                const res = await fetch(`/api/bookings/${bookingId}`);
                if (res.ok) {
                    const b = await res.json();
                    const merged = cached || {};
                    merged.seatNumbers = b.seatNumbers;
                    merged.totalAmount = b.totalAmount;
                    renderSummary(merged);
                } else if (res.status === 404) {
                    console.warn(`Booking ${bookingId} not found`);
                    alert('Booking not found. Please create a new booking.');
                    window.location.href = '../../IT24102460/HTML/mem_shedule.html';
                } else {
                    console.error(`Failed to load booking ${bookingId}: ${res.status}`);
                    renderSummary(cached);
                }
            } catch(error) { 
                console.error('Error loading booking:', error);
                renderSummary(cached); 
            }
        }
        loadBooking();

        const paymentForm = document.getElementById('payment-form');
        const formTitle = document.getElementById('form-title');
        const paymentMethodId = document.getElementById('payment-method-id');
        const cardHolderInput = document.getElementById('card-holder');
        const cardNumberInput = document.getElementById('card-number');
        const expiryDateInput = document.getElementById('expiry-date');
        const cvvInput = document.getElementById('cvv');

        const fetchPaymentMethods = async () => {
            try {
                const response = await fetch(`/api/payment-methods/${userId}`);
                const methods = await response.json();
                renderPaymentMethods(methods);
            } catch (error) {
                console.error('Error fetching payment methods:', error);
            }
        };

        const renderPaymentMethods = (methods) => {
            methodsGrid.innerHTML = '';
            methods.forEach(method => {
                const card = document.createElement('div');
                card.classList.add('payment-method-card');
                card.dataset.id = method.id;
                card.innerHTML = `
                    <div class="method-header">
                        <h4>${method.method || 'Card'}</h4>
                        <div class="method-actions">
                            <button class="edit-btn" title="Edit">✏️</button>
                            <button class="delete-btn" title="Delete">🗑️</button>
                        </div>
                    </div>
                    <div class="card-details">
                        <div class="card-number">**** **** **** ${method.cardNumber ? method.cardNumber.slice(-4) : ''}</div>
                        <div class="card-expiry">Expires: ${method.expiryDate || ''}</div>
                        <div class="card-holder">${method.cardholderName || ''}</div>
                    </div>
                `;
                methodsGrid.appendChild(card);
            });
        };

        methodsGrid.addEventListener('click', (e) => {
            const card = e.target.closest('.payment-method-card');
            if (!card) return;
            if (e.target.classList.contains('edit-btn')) {
                const methodId = card.dataset.id;
                const method = {
                    id: methodId,
                    cardholderName: card.querySelector('.card-holder').textContent,
                    cardNumber: '',
                    expiryDate: card.querySelector('.card-expiry').textContent.replace('Expires: ', ''),
                };
                showForm(true, method);
            } else if (e.target.classList.contains('delete-btn')) {
                const methodId = card.dataset.id;
                if (confirm('Are you sure you want to delete this payment method?')) {
                    deletePaymentMethod(methodId);
                }
            } else {
                document.querySelectorAll('.payment-method-card').forEach(c => c.classList.remove('active'));
                card.classList.add('active');
            }
        });

        const showForm = (isEdit = false, method = null) => {
            formTitle.textContent = isEdit ? 'Edit Payment Method' : 'Add New Payment Method';
            paymentMethodId.value = isEdit ? method.id : '';
            cardHolderInput.value = isEdit ? method.cardholderName : '';
            cardNumberInput.value = '';
            expiryDateInput.value = isEdit ? method.expiryDate : '';
            cvvInput.value = '';
            paymentForm.style.display = 'block';
            window.scrollTo(0, paymentForm.offsetTop - 100);
        };

        const hideForm = () => {
            paymentForm.style.display = 'none';
            paymentForm.querySelector('form').reset();
        };

        document.querySelector('.add-method').addEventListener('click', () => showForm());
        document.querySelector('.cancel-form').addEventListener('click', () => hideForm());

        paymentForm.querySelector('form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const methodId = paymentMethodId.value;
            const methodData = {
                user: { id: userId },
                method: 'VISA',
                cardholderName: cardHolderInput.value,
                cardNumber: cardNumberInput.value,
                expiryDate: expiryDateInput.value,
                cvv: cvvInput.value,
            };
            if (methodId) {
                await updatePaymentMethod(methodId, methodData);
            } else {
                await addPaymentMethod(methodData);
            }
        });

        const addPaymentMethod = async (methodData) => {
            try {
                const response = await fetch('/api/payment-methods', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(methodData),
                });
                if (response.ok) {
                    hideForm();
                    fetchPaymentMethods();
                } else {
                    alert('Error adding payment method');
                }
            } catch (error) {
                alert('Error adding payment method: ' + error.message);
            }
        };

        const updatePaymentMethod = async (id, methodData) => {
            try {
                const response = await fetch(`/api/payment-methods/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(methodData),
                });
                if (response.ok) {
                    hideForm();
                    fetchPaymentMethods();
                } else {
                    alert('Error updating payment method');
                }
            } catch (error) {
                alert('Error updating payment method: ' + error.message);
            }
        };

        const deletePaymentMethod = async (id) => {
            try {
                const response = await fetch(`/api/payment-methods/${id}`, { method: 'DELETE' });
                if (response.ok) fetchPaymentMethods();
            } catch (error) {}
        };

        document.querySelector('.proceed-payment').addEventListener('click', async function () {
            const activeMethod = document.querySelector('.payment-method-card.active');
            if (!activeMethod) {
                alert('Please select a payment method to proceed.');
                return;
            }
            
            const summary = (() => { try { return JSON.parse(localStorage.getItem('slraile_current_booking_summary')); } catch(_) { return null; }})();
            
            console.log('Booking ID:', bookingId);
            console.log('Summary:', summary);
            
            if (!bookingId) {
                alert('Missing booking ID. Please go back and create a booking first.');
                return;
            }
            
            if (!summary) {
                alert('Missing booking summary. Please go back and create a booking first.');
                return;
            }
            
            if (!summary.totalAmount || summary.totalAmount <= 0) {
                alert('Invalid booking amount. Please go back and create a booking first.');
                return;
            }

            // Check if booking is already paid before attempting payment
            try {
                const bookingRes = await fetch(`/api/bookings/${bookingId}`);
                if (bookingRes.ok) {
                    const booking = await bookingRes.json();
                    if (booking.status === 'PAID') {
                        alert('This booking has already been paid. Redirecting to booking history...');
                        window.location.href = '../../IT24101558/HTML/bookinghistory.html';
                        return;
                    }
                } else if (bookingRes.status === 404) {
                    alert('Booking not found. Please create a new booking.');
                    window.location.href = '../../IT24102460/HTML/mem_shedule.html';
                    return;
                } else {
                    console.warn(`Failed to check booking status: ${bookingRes.status}`);
                }
            } catch (error) {
                console.warn('Could not check booking status:', error);
                // Continue with payment attempt if we can't check status
            }
            const req = {
                bookingId: bookingId,
                amount: Number(String(summary.totalAmount).replace(/[^0-9.]/g,'')) || 0,
                method: 'VISA',
                payerName: userEmail,
                payerEmail: userEmail,
                cardLast4: activeMethod.querySelector('.card-number').textContent.slice(-4),
                transactionId: 'TX-' + Date.now()
            };
            try {
                console.log('Payment request:', req);
                
                const ORIGIN = (window.location.origin.startsWith('file:') || window.location.origin === 'null')
                    ? 'http://localhost:8080'
                    : window.location.origin;
                
                const res = await fetch(`${ORIGIN}/api/payments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(req)
                });
                
                console.log('Payment response status:', res.status);
                console.log('Payment response ok:', res.ok);
                
                if (!res.ok) {
                    const errorText = await res.text();
                    console.error('Payment error response:', errorText);
                    
                    // Parse error message for better user feedback
                    let errorMessage = 'Payment failed';
                    try {
                        const errorObj = JSON.parse(errorText);
                        const errorString = typeof errorObj === 'string' ? errorObj : JSON.stringify(errorObj);
                        
                        if (errorString.includes('already paid')) {
                            errorMessage = 'This booking has already been paid. Redirecting to booking history...';
                            setTimeout(() => {
                                window.location.href = '../../IT24101558/HTML/bookinghistory.html';
                            }, 2000);
                        } else if (errorString.includes('Booking not found')) {
                            errorMessage = 'Booking not found. Please create a new booking.';
                        } else {
                            errorMessage = errorString;
                        }
                    } catch (e) {
                        errorMessage = errorText || `Payment failed with status ${res.status}`;
                    }
                    
                    throw new Error(errorMessage);
                }
                
                const paymentResult = await res.json();
                console.log('Payment successful:', paymentResult);
                
                // Success UI and redirect to history
                const mainContent = document.querySelector('.main-content');
                mainContent.innerHTML = `
                  <section class="success-message">
                    <h2>Payment Successful!</h2>
                    <p>Your payment has been processed successfully.</p>
                    <p>Transaction ID: ${paymentResult.transactionId || req.transactionId}</p>
                    <button class="btn go-to-history" onclick="window.location.href='../../IT24101558/HTML/bookinghistory.html'">Go to Booking History</button>
                  </section>
                `;
            } catch (err) {
                console.error('Payment error:', err);
                alert('Payment failed: ' + err.message);
            }
        });

        // Cancel payment
        document.querySelector('.cancel-payment').addEventListener('click', function() {
            if (confirm('Are you sure you want to cancel this payment process?')) {
                window.location.href = '../../IT24102460/HTML/mem_shedule.html';
            }
        });

        fetchPaymentMethods();
    });
</script>
</body>
</html>