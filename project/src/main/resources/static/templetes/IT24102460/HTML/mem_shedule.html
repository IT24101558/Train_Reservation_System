<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Member Schedule - CityRail Express</title>
    <link rel="stylesheet" href="../CSS/mem_shedule.css">
</head>
<body>
<header class="header">
    <div class="logo-container">
        <div class="train-icon"></div>
        <h1>SLRailE</h1>
    </div>
    <nav class="navigation">
        <ul>
            <li><a href="../../IT24101525/HTML/userprofile.html">My Profile</a></li>
            <li><a href="#" class="active">Schedule</a></li>
            <li><a href="../../IT24101558/HTML/bookinghistory.html">Booking History</a></li>
            <li><a href="../../IT24300073/HTML/notification.html">Notifications</a></li>
            <li><a href="../../IT24101009/HTML/mem-feedback.html">Feedback</a></li>
            <li><a href="../../IT24101525/HTML/usersettings.html">Settings</a></li>
            <li><a href="../../IT24101208/HTML/member-logout.html">Logout</a></li>
        </ul>
    </nav>
</header>

<main class="main-content">
    <section class="search-container">
        <h2 style="text-align: center;">Find Your Train Here!</h2>
        <div class="search-form">
            <div class="form-row">
                <div class="input-group">
                    <label for="from">From</label>
                    <input type="text" id="from" name="from" placeholder="Type departure station">
                </div>
                <div class="input-group">
                    <label for="to">To</label>
                    <input type="text" id="to" name="to" placeholder="Type destination station">
                </div>
                <div class="input-group">
                    <label for="userType">User Type</label>
                    <select id="userType" name="userType">
                        <option value="MEMBER" selected>Member</option>
                        <option value="GUEST">Guest</option>
                    </select>
                </div>
            </div>
            
            <div class="button-group">
                <button class="search-btn">Search Trains</button>
                <button type="button" class="search-btn refresh-btn" onclick="fetchAndRenderSchedules()">Refresh Schedules</button>
            </div>
        </div>
    </section>

    <section class="schedule-container">
        <div class="tabs">
            <button class="tab-btn active" data-tab="today">Today's Schedule</button>
        </div>

        <div class="schedule-table-container">
            <table class="schedule-table">
                <thead>
                <tr>
                    <th>Train</th>
                    <th>From</th>
                    <th>To</th>
                    <th>Departure</th>
                    <th>Arrival</th>
                    <th>Duration</th>
                    <th>Platform</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
                </thead>
                <tbody id="schedule-body">
                    <!-- Today's schedules will be loaded here -->
                </tbody>
            </table>
        </div>
    </section>

    <section class="results-container">
        <div class="results-header">
            <h2>Famous Train Rides</h2>
            <div class="sort-container">
                <label for="sort">Sort by:</label>
                <select id="sort" name="sort">
                    <option value="departure">Departure Time</option>
                    <option value="duration" selected>Duration</option>
                    <option value="price">Price</option>
                    <option value="rating">Customer Rating</option>
                </select>
            </div>
        </div>

        <div class="train-results">
            <!-- Train 1 -->
            <div class="train-card" data-train-id="101">
                <div class="train-header">
                    <div class="train-info">
                        <div class="train-number">Mountain Route</div>
                        <div class="train-type">Scenic journey through the highlands</div>
                    </div>
                    <div class="train-pricing">
                        <div class="price">From Rs.400.00</div>
                        <div class="save-tag">Save 15% as Member</div>
                    </div>
                </div>

                <div class="train-schedule">
                    <div class="departure">
                        <div class="time">05:30AM</div>
                        <div class="station">Colombo</div>
                        <div class="platform">Platform 3</div>
                    </div>
                    <div class="duration">
                        <div class="line"></div>
                        <div class="time">3h 10m</div>
                        <div class="direct">Direct</div>
                    </div>
                    <div class="arrival">
                        <div class="time">08:40AM</div>
                        <div class="station">Kandy</div>
                        <div class="platform">Platform 2</div>
                    </div>
                </div>

                <div class="class-options">
                    <div class="class-option selected" data-class="economy">
                        <div class="class-name">Economy</div>
                        <div class="class-price">Rs.400.00</div>
                        <div class="class-features">
                            <span>Standard seating</span>
                            <span>Basic amenities</span>
                        </div>
                    </div>
                    <div class="class-option" data-class="business">
                        <div class="class-name">Business</div>
                        <div class="class-price">Rs.800.00</div>
                        <div class="class-features">
                            <span>Spacious seating</span>
                            <span>Work tables</span>
                            <span>Complimentary snacks</span>
                        </div>
                        <div class="popular-tag">Most Popular</div>
                    </div>
                    <div class="class-option" data-class="first">
                        <div class="class-name">First Class</div>
                        <div class="class-price">Rs.1200.00</div>
                        <div class="class-features">
                            <span>Luxury seating</span>
                            <span>Personal attendant</span>
                            <span>Gourmet meals</span>
                            <span>Priority boarding</span>
                        </div>
                    </div>
                </div>

                <div class="train-actions">
                    <a href="../../IT24101525/HTML/seatallocation.html" class="select-btn">Book Now</a>
                </div>
            </div>

            <!-- Train 2 -->
            <div class="train-card" data-train-id="205">
                <div class="train-header">
                    <div class="train-info">
                        <div class="train-number">Heritage Route</div>
                        <div class="train-type">SCENIC JOURNEY THROUGH THE HILLS & TEA PLANTATIONS</div>
                    </div>
                    <div class="train-pricing">
                        <div class="price">From Rs.500.00</div>
                        <div class="save-tag">Save 15% as Member</div>
                    </div>
                </div>

                <div class="train-schedule">
                    <div class="departure">
                        <div class="time">12:10PM</div>
                        <div class="station">Kandy</div>
                        <div class="platform">Platform 5</div>
                    </div>
                    <div class="duration">
                        <div class="line"></div>
                        <div class="time">7h 50m</div>
                        <div class="direct">Direct</div>
                    </div>
                    <div class="arrival">
                        <div class="time">20:00PM</div>
                        <div class="station">Ella</div>
                        <div class="platform">Platform 4</div>
                    </div>
                </div>

                <div class="class-options">
                    <div class="class-option selected" data-class="economy">
                        <div class="class-name">Economy</div>
                        <div class="class-price">Rs.500.00</div>
                        <div class="class-features">
                            <span>Standard seating</span>
                            <span>Basic amenities</span>
                        </div>
                    </div>
                    <div class="class-option" data-class="business">
                        <div class="class-name">Business</div>
                        <div class="class-price">Rs.1400.00</div>
                        <div class="class-features">
                            <span>Spacious seating</span>
                            <span>Work tables</span>
                            <span>Complimentary snacks</span>
                        </div>
                    </div>
                </div>

                <div class="train-actions">
                    <a href="../../IT24101525/HTML/seatallocation.html" class="select-btn">Book Now</a>
                </div>
            </div>

            <!-- Train 3 -->
            <div class="train-card" data-train-id="103">
                <div class="train-header">
                    <div class="train-info">
                        <div class="train-number">Northern Route</div>
                        <div class="train-type">CENIC RIDE ACROSS VAST PLAINS & TAMIL HEARTLAND</div>
                    </div>
                    <div class="train-pricing">
                        <div class="price">From Rs.450.00</div>
                        <div class="save-tag">Save 15% as Member</div>
                    </div>
                </div>

                <div class="train-schedule">
                    <div class="departure">
                        <div class="time">14:15PM</div>
                        <div class="station">Anuradapura</div>
                        <div class="platform">Platform 2</div>
                    </div>
                    <div class="duration">
                        <div class="line"></div>
                        <div class="time">3h 45m</div>
                        <div class="direct">Direct</div>
                    </div>
                    <div class="arrival">
                        <div class="time">18:00PM</div>
                        <div class="station">Jaffna</div>
                        <div class="platform">Platform 3</div>
                    </div>
                </div>

                <div class="class-options">
                    <div class="class-option" data-class="economy">
                        <div class="class-name">Economy</div>
                        <div class="class-price">Rs.450.00</div>
                        <div class="class-features">
                            <span>Standard seating</span>
                            <span>Basic amenities</span>
                        </div>
                    </div>
                    <div class="class-option selected" data-class="business">
                        <div class="class-name">Business</div>
                        <div class="class-price">Rs.1000.00</div>
                        <div class="class-features">
                            <span>Spacious seating</span>
                            <span>Work tables</span>
                            <span>Complimentary snacks</span>
                        </div>
                        <div class="popular-tag">Most Popular</div>
                    </div>
                    <div class="class-option" data-class="first">
                        <div class="class-name">First Class</div>
                        <div class="class-price">Rs.1200.00</div>
                        <div class="class-features">
                            <span>Luxury seating</span>
                            <span>Personal attendant</span>
                            <span>Gourmet meals</span>
                            <span>Priority boarding</span>
                        </div>
                    </div>
                </div>

                <div class="train-actions">
                    <a href="../../IT24101525/HTML/seatallocation.html" class="select-btn">Book Now</a>
                </div>
            </div>
        </div>
    </section>
</main>

<footer class="footer">
    <div class="footer-content">
        <div class="footer-logo">
            <h3>SLRailE</h3>
            <p>SLRailE is your all-in-one digital companion for train travel across Sri Lanka. Designed to make journeys smoother and more convenient, SLRailE provides real-time train schedules, route planning, and live updates on arrivals, departures, and delays.</p>
            <p>Whether you're a daily commuter or a tourist exploring the island's breathtaking scenery, SLRailE is your essential partner for smart and seamless railway travel.</p>
        </div>
        <div class="footer-links">
            <div class="link-column">
                <h4>Services</h4>
                <ul>
                    <li><a href="#">Schedule</a></li>
                    <li><a href="#">Tickets</a></li>
                    <li><a href="#">Reservations</a></li>
                    <li><a href="#">Luggage</a></li>
                </ul>
            </div>
            <div class="link-column">
                <h4>Information</h4>
                <ul>
                    <li><a href="#">About Us</a></li>
                    <li><a href="#">Careers</a></li>
                    <li><a href="#">News</a></li>
                    <li><a href="#">Contact</a></li>
                </ul>
            </div>
            <div class="link-column">
                <h4>Legal</h4>
                <ul>
                    <li><a href="#">Privacy Policy</a></li>
                    <li><a href="#">Terms of Service</a></li>
                    <li><a href="#">Cookie Policy</a></li>
                </ul>
            </div>
        </div>
    </div>
    <div class="copyright">
        <p>&copy; 2025 SLRailE. All rights reserved.</p>
    </div>
</footer>


<script>
    // Store selected train and class
    let selectedTrain = null;
    let selectedClass = null;

    // Train selection
    document.querySelectorAll('.select-btn').forEach(button => {
        button.addEventListener('click', function() {
            const trainCard = this.closest('.train-card');
            const trainId = trainCard.getAttribute('data-train-id');

            // Find the selected class option
            const selectedClassOption = trainCard.querySelector('.class-option.selected');
            const className = selectedClassOption.querySelector('.class-name').textContent;
            const price = selectedClassOption.querySelector('.class-price').textContent;

            // Update the booking modal with train details
            document.getElementById('booking-train').textContent = trainCard.querySelector('.train-number').textContent;

            const departureStation = trainCard.querySelector('.departure .station').textContent;
            const arrivalStation = trainCard.querySelector('.arrival .station').textContent;
            document.getElementById('booking-route').textContent = `${departureStation} to ${arrivalStation}`;

            const dateInput = document.getElementById('date');
            const dateValue = dateInput.value;
            const dateObj = new Date(dateValue);
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('booking-date').textContent = dateObj.toLocaleDateString('en-US', options);

            document.getElementById('booking-departure').textContent = trainCard.querySelector('.departure .time').textContent;
            document.getElementById('booking-arrival').textContent = trainCard.querySelector('.arrival .time').textContent;
            document.getElementById('booking-class').textContent = className;
            document.getElementById('booking-total').textContent = price;

            // Store selected values
            selectedTrain = trainId;
            selectedClass = className;

            // Show booking modal
            document.getElementById('booking-modal').style.display = 'flex';
        });
    });

    // Class selection within a train
    document.querySelectorAll('.class-option').forEach(option => {
        option.addEventListener('click', function() {
            // Remove selected class from siblings
            const parent = this.parentNode;
            parent.querySelectorAll('.class-option').forEach(sibling => {
                sibling.classList.remove('selected');
            });

            // Add selected class to clicked option
            this.classList.add('selected');
        });
    });

    // Booking modal functionality
    const bookingModal = document.getElementById('booking-modal');
    const confirmationModal = document.getElementById('confirmation-modal');
    const closeButtons = document.querySelectorAll('.close');

    // Close modals when clicking the X
    closeButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            this.closest('.modal').style.display = 'none';
        });
    });

    // Close modals when clicking outside
    window.addEventListener('click', function(event) {
        if (event.target === bookingModal) {
            bookingModal.style.display = 'none';
        }
        if (event.target === confirmationModal) {
            confirmationModal.style.display = 'none';
        }
    });

    // Confirm booking
    document.querySelector('.confirm-btn').addEventListener('click', function() {
        bookingModal.style.display = 'none';
        confirmationModal.style.display = 'flex';

        // Animate confirmation
        const confirmationContent = confirmationModal.querySelector('.modal-content');
        confirmationContent.style.transform = 'scale(0.8)';
        confirmationContent.style.opacity = '0';

        setTimeout(() => {
            confirmationContent.style.transform = 'scale(1)';
            confirmationContent.style.opacity = '1';
            confirmationContent.style.transition = 'all 0.3s ease';
        }, 10);
    });

    // Done button in confirmation
    document.querySelector('.done-btn').addEventListener('click', function() {
        confirmationModal.style.display = 'none';
    });

    // Download button
    document.querySelector('.download-btn').addEventListener('click', function() {
        // In a real app, this would trigger a PDF download
        alert('Ticket downloaded successfully!');
    });

    // Email button
    document.querySelector('.email-btn').addEventListener('click', function() {
        // In a real app, this would send an email
        alert('Ticket sent to your email!');
        this.textContent = 'Sent!';
        this.disabled = true;
        setTimeout(() => {
            this.textContent = 'Email Ticket';
            this.disabled = false;
        }, 2000);
    });

    // Cancel booking
    document.querySelector('.cancel-btn').addEventListener('click', function() {
        bookingModal.style.display = 'none';
    });

    // Quick action buttons
    document.querySelectorAll('.action-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const action = this.querySelector('span').textContent;
            alert(`${action} feature would open here.`);
        });
    });

    // Add animation to elements
    document.addEventListener('DOMContentLoaded', function() {
        // Animate train cards
        const trainCards = document.querySelectorAll('.train-card');
        trainCards.forEach((card, index) => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(30px)';
            setTimeout(() => {
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
                card.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
            }, 100 + index * 150);
        });

        // Animate quick actions
        const quickActions = document.querySelectorAll('.quick-actions .action-btn');
        quickActions.forEach((action, index) => {
            action.style.opacity = '0';
            action.style.transform = 'translateY(20px)';
            setTimeout(() => {
                action.style.opacity = '1';
                action.style.transform = 'translateY(0)';
                action.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
            }, 300 + index * 100);
        });
    });
// Add dynamic search to call backend
document.addEventListener('DOMContentLoaded', () => {
    // Find the main search button (not the refresh/clear buttons)
    const searchBtn = document.querySelector('.button-group .search-btn:first-child');
    if (searchBtn) {
        searchBtn.addEventListener('click', (e) => {
            e.preventDefault(); // Prevent form submission
            const from = document.getElementById('from')?.value.trim();
            const to = document.getElementById('to')?.value.trim();
            const userType = document.getElementById('userType')?.value || 'MEMBER';
            console.log('=== SEARCH BUTTON CLICKED ===');
            console.log('From:', from);
            console.log('To:', to);
            console.log('UserType:', userType);
            // Search should filter the Today's Schedule table
            fetchAndRenderSchedules({ routeFrom: from || null, routeTo: to || null, userType });
        });
    } else {
        console.error('Search button not found!');
    }
    // initial load: show all schedules for member
    fetchAndRenderSchedules({ userType: 'MEMBER' });

    // auto-refresh every 10s to reflect admin changes using current filters
    setInterval(() => {
        const from = document.getElementById('from')?.value.trim();
        const to = document.getElementById('to')?.value.trim();
        const userType = document.getElementById('userType')?.value || 'MEMBER';
        fetchAndRenderSchedules({ routeFrom: from || null, routeTo: to || null, userType });
    }, 10000);
});

function fetchSchedules({ routeFrom = null, routeTo = null, userType = 'MEMBER' } = {}) {
    const ORIGIN = (window.location.origin.startsWith('file:') || window.location.origin === 'null')
        ? 'http://localhost:8080'
        : window.location.origin;
    const base = userType === 'GUEST' ? `${ORIGIN}/api/guest/schedules` : `${ORIGIN}/api/member/schedules`;
    const params = new URLSearchParams();
    if (routeFrom) params.append('routeFrom', routeFrom);
    if (routeTo) params.append('routeTo', routeTo);
    const url = params.toString() ? `${base}/search?${params.toString()}` : base;
    fetch(url)
        .then(r => r.json())
        .then(data => renderMemberResults(data))
        .catch(e => console.error('Failed to fetch schedules', e));
}

function renderMemberResults(items) {
    const container = document.querySelector('.train-results');
    if (!container) return;
    container.innerHTML = '';
    if (!items || items.length === 0) {
        const empty = document.createElement('div');
        empty.style.padding = '1rem';
        empty.textContent = 'No trains found for the given criteria.';
        container.appendChild(empty);
        return;
    }
    items.forEach(it => {
        const card = document.createElement('div');
        card.className = 'train-card';
        card.innerHTML = `
            <div class="train-header">
                <div class="train-info">
                    <div class="train-number">${it.trainName || ''}</div>
                    <div class="train-type">${it.trainType || ''}</div>
                </div>
                <div class="train-pricing">
                    <div class="price">From Rs.${it.economyPrice?.toFixed ? it.economyPrice.toFixed(2) : it.economyPrice}</div>
                    <div class="save-tag">Save 15% as Member</div>
                </div>
            </div>
            <div class="train-schedule">
                <div class="departure">
                    <div class="time">${(it.departureTime || '').toString().slice(0,5)}</div>
                    <div class="station">From: ${it.routeFrom || ''}</div>
                    <div class="platform">Platform ${it.platform ?? ''}</div>
                </div>
                <div class="duration">
                    <div class="line"></div>
                    <div class="time">${it.duration || ''}</div>
                    <div class="direct">Direct</div>
                </div>
                <div class="arrival">
                    <div class="time">${(it.arrivalTime || '').toString().slice(0,5)}</div>
                    <div class="station">To: ${it.routeTo || ''}</div>
                    <div class="platform">Platform ${it.platform ?? ''}</div>
                </div>
            </div>
            <div class="train-actions">
                <a href="../../IT24101525/HTML/seatallocation.html" class="select-btn">Book Now</a>
            </div>
        `;
        container.appendChild(card);
    });
}

function fetchAndRenderSchedules({ routeFrom = null, routeTo = null, userType = 'MEMBER' } = {}) {
    console.log('=== fetchAndRenderSchedules called ===');
    console.log('routeFrom:', routeFrom);
    console.log('routeTo:', routeTo);
    console.log('userType:', userType);
    
    const ORIGIN = (window.location.origin.startsWith('file:') || window.location.origin === 'null')
        ? 'http://localhost:8080'
        : window.location.origin;
    // Use appropriate endpoint based on userType
    const base = userType === 'GUEST' ? `${ORIGIN}/api/guest/schedules` : `${ORIGIN}/api/member/schedules`;
    const params = new URLSearchParams();
    if (routeFrom) params.append('routeFrom', routeFrom);
    if (routeTo) params.append('routeTo', routeTo);
    const url = params.toString() ? `${base}/search?${params.toString()}` : base;

    console.log('ORIGIN:', ORIGIN);
    console.log('Base URL:', base);
    console.log('Search params:', params.toString());
    console.log('Final URL:', url);
    
    fetch(url)
        .then(res => {
            console.log('Response status:', res.status);
            console.log('Response ok:', res.ok);
            if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
            }
            return res.json();
        })
        .then(data => {
            console.log('Schedules data received:', data);
            console.log('Data type:', typeof data);
            console.log('Data length:', Array.isArray(data) ? data.length : 'not an array');
            renderTable(data);
        })
        .catch(err => {
            console.error('Failed to fetch schedules', err);
            console.error('Error details:', err.message);
            const tbody = document.getElementById('schedule-body');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="9" style="color: red;">Error loading schedules. Check console for details.</td></tr>';
            }
        });
}

function renderTable(items) {
    const tbody = document.getElementById('schedule-body');
    console.log('renderTable called with:', items);
    console.log('tbody element:', tbody);
    
    if (!tbody) {
        console.error('schedule-body tbody not found!');
        return;
    }
    
    tbody.innerHTML = '';
    
    if (!items || items.length === 0) {
        console.log('No items to render, showing empty message');
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 9;
        td.textContent = 'No trains found for the given criteria.';
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
    }
    
    console.log(`Rendering ${items.length} schedule items`);
    items.forEach((it, index) => {
        console.log(`Rendering item ${index}:`, it);
        const tr = document.createElement('tr');
        tr.className = 'schedule-row';
        tr.style.setProperty('--delay', `${index * 0.1}s`);
        // Force visibility
        tr.style.opacity = '1';
        tr.style.transform = 'translateY(0)';
        
        tr.innerHTML = `
            <td class="train-name">${it.trainName || ''}</td>
            <td class="from">${it.routeFrom || ''}</td>
            <td class="to">${it.routeTo || ''}</td>
            <td class="departure-time">${(it.departureTime || '').toString().slice(0,5)}</td>
            <td class="arrival-time">${(it.arrivalTime || '').toString().slice(0,5)}</td>
            <td class="duration">${it.duration || ''}</td>
            <td class="platform">${it.platform ?? ''}</td>
            <td class="status status-${(it.status || '').toString().toLowerCase()}">${it.status || ''}</td>
            <td><a href="../../IT24101525/HTML/seatallocation.html" class="book-btn">Book</a></td>
        `;
        tbody.appendChild(tr);
    });
}

// Load schedules on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded, fetching initial schedules...');
    console.log('Current URL:', window.location.href);
    console.log('Origin:', window.location.origin);
    fetchAndRenderSchedules();
    
    // Auto-refresh every 10 seconds
    setInterval(() => {
        console.log('Auto-refreshing schedules...');
        fetchAndRenderSchedules();
    }, 10000);
});

// Also try to load immediately if DOM is already loaded
if (document.readyState === 'loading') {
    console.log('DOM still loading, waiting for DOMContentLoaded...');
} else {
    console.log('DOM already loaded, fetching schedules immediately...');
    fetchAndRenderSchedules();
}

// Clear search function
function clearSearch() {
    console.log('Clearing search filters...');
    document.getElementById('from').value = '';
    document.getElementById('to').value = '';
    document.getElementById('userType').value = 'MEMBER';
    // Load all schedules without filters
    fetchAndRenderSchedules();
}
</script>
</body>
</html>