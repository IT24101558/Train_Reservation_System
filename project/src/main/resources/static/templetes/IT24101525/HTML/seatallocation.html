<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Select Your Seat - SLRailE</title>
    <link rel="stylesheet" href="/templetes/IT24101525/CSS/seatallocation.css">
  <script src="/js/user-utils.js"></script>
</head>
<body>
<!-- Header -->
<header class="header">
    <div class="logo-container">
        <div class="train-icon"></div>
        <h1>SLRailE</h1>
    </div>
    <nav class="navigation">
        <ul>
            <li><a href="../../IT24101525/HTML/userprofile.html">My Profile</a></li>
            <li><a href="../../IT24102460/HTML/mem_shedule.html" class="active">Schedule</a></li>
            <li><a href="../../IT24101558/HTML/bookinghistory.html">Booking History</a></li>
            <li><a href="../../IT24300073/HTML/notification.html">Notifications</a></li>
            <li><a href="../../IT24101009/HTML/mem-feedback.html">Feedback</a></li>
            <li><a href="../../IT24101525/HTML/usersettings.html">Settings</a></li>
            <li><a href="../../IT24101208/HTML/member-logout.html">Logout</a></li>
        </ul>
    </nav>
</header>

<main class="main-content">
    <!-- Booking Summary -->
    <section class="booking-summary">
        <h2>Booking Overview</h2>
        <div class="summary-row">
            <strong>Train:</strong> <span id="bo-train">-</span>
        </div>
        <div class="summary-row">
            <strong>From:</strong> <span id="bo-route">-</span>
        </div>
        <div class="summary-row">
            <strong>Date:</strong> <span id="bo-date">-</span>
        </div>
        <div class="summary-row">
            <strong>Departure:</strong> <span id="bo-departure">-</span>
        </div>
         <div class="summary-row">
             <strong>Arrival:</strong> <span id="bo-arrival">-</span>
         </div>
         <div class="summary-row">
             <strong>Platform:</strong> <span id="bo-platform">-</span>
         </div>
        <div class="summary-row">
            <strong>Class:</strong> <span id="selected-class">Second</span>
        </div>
    </section>

    <!-- Seat Selection Section -->
    <section class="seat-selection-container">
        <div class="title-with-button">
            <h2>Select Your Seat</h2>
            <button class="btn-360">360° View</button>
        </div>

        <!-- Class Selector -->
        <div class="class-selector">
            <label>Select Class:</label>
            <div class="class-buttons">
                <button class="class-btn active" data-class="second">Second</button>
                <button class="class-btn" data-class="firstclass">First</button>
            </div>
        </div>

        <!-- Legend -->
        <div class="legend">
            <div class="legend-item">
                <div class="seat available"></div>
                <span>Available</span>
            </div>
            <div class="legend-item">
                <div class="seat selected"></div>
                <span>Selected</span>
            </div>
            <div class="legend-item">
                <div class="seat occupied"></div>
                <span>Occupied</span>
            </div>
        </div>

        <!-- Train Car Layout -->
        <div class="train-layout">
            <div class="car-label">Train 03</div>
            <div class="seat-map" id="seat-map"></div>
        </div>

        <!-- Selected Seats Summary -->
        <div class="selection-summary">
            <h3>Selected Seats</h3>
            <div id="selected-seats-list">
                <p>No seats selected.</p>
            </div>
            <div class="total-price">
                Total: <strong id="total-price">Rs. 400.00</strong>
            </div>
            <div class="action-buttons">
                <button class="btn cancel">Cancel</button>
                <a href="../../IT24101558/HTML/payment.html" class="btn confirm">Confirm & Continue</a>
            </div>
        </div>
    </section>
</main>

<!-- Footer -->
<footer class="footer">
    <div class="footer-content">
        <div class="footer-logo">
            <h3>SLRailE</h3>
            <p>SLRailE is your all-in-one digital companion for train travel across Sri Lanka. Designed to make journeys smoother and more convenient, SLRailE provides real-time train schedules, route planning, and live updates on arrivals, departures, and delays.</p>
            <p>Whether you're a daily commuter or a tourist exploring the island's breathtaking scenery, SLRailE is your essential partner for smart and seamless railway travel.</p>
        </div>
        <div class="footer-links">
            <div class="link-column">
                <h4>Services</h4>
                <ul>
                    <li><a href="#">Schedule</a></li>
                    <li><a href="#">Tickets</a></li>
                    <li><a href="#">Reservations</a></li>
                    <li><a href="#">Luggage</a></li>
                </ul>
            </div>
            <div class="link-column">
                <h4>Information</h4>
                <ul>
                    <li><a href="#">About Us</a></li>
                    <li><a href="#">Careers</a></li>
                    <li><a href="#">News</a></li>
                    <li><a href="#">Contact</a></li>
                </ul>
            </div>
            <div class="link-column">
                <h4>Legal</h4>
                <ul>
                    <li><a href="#">Privacy Policy</a></li>
                    <li><a href="#">Terms of Service</a></li>
                    <li><a href="#">Cookie Policy</a></li>
                </ul>
            </div>
        </div>
    </div>
    <div class="copyright">
        <p>&copy; 2025 SLRailE. All rights reserved.</p>
    </div>
</footer>

<!-- Script -->
<script>
    // Seat pricing
    const prices = {
        second: 400,
        firstclass: 1200
    };

    let selectedClass = 'second';
    let selectedSeats = [];
    let maxSelections = 6;

    // Generate seat map
    function generateSeats() {
        const seatMap = document.getElementById('seat-map');
        seatMap.innerHTML = '';

        const rows = selectedClass === 'firstclass' ? 4 : 10;
        const cols = selectedClass === 'firstclass' ? 2 : 6;

        for (let row = 1; row <= rows; row++) {
            const rowEl = document.createElement('div');
            rowEl.classList.add('seat-row');

            for (let col = 1; col <= cols; col++) {
                const seatId = `${String.fromCharCode(64 + col)}${row}`;
                const seat = document.createElement('div');
                seat.classList.add('seat', 'available');
                seat.dataset.id = seatId;

                if (Math.random() < 0.3) {
                    seat.classList.replace('available', 'occupied');
                } else {
                    seat.onclick = function () {
                        toggleSeat(this);
                    };
                }

                 // no window seat indicator

                rowEl.appendChild(seat);
            }
            seatMap.appendChild(rowEl);
        }
    }

    // Toggle seat selection
    function toggleSeat(seat) {
        if (seat.classList.contains('occupied')) return;

        const seatId = seat.dataset.id;
        const index = selectedSeats.indexOf(seatId);

        if (index > -1) {
            seat.classList.remove('selected');
            selectedSeats.splice(index, 1);
        } else if (selectedSeats.length < maxSelections) {
            seat.classList.add('selected');
            selectedSeats.push(seatId);
        } else {
            alert(`You can select up to ${maxSelections} seats.`);
            return;
        }

        updateSelectionSummary();
    }

    // Update selected seats list and price
    function updateSelectionSummary() {
        const list = document.getElementById('selected-seats-list');
        const price = document.getElementById('total-price');

        if (selectedSeats.length === 0) {
            list.innerHTML = '<p>No seats selected.</p>';
            price.textContent = `Rs. 0.00`;
        } else {
            list.innerHTML = '';
            const ul = document.createElement('ul');
            selectedSeats.forEach(seat => {
                const li = document.createElement('li');
                li.textContent = seat;
                li.onclick = () => {
                    document.querySelector(`[data-id="${seat}"]`).click();
                };
                ul.appendChild(li);
            });
            list.appendChild(ul);
            price.textContent = `Rs. ${(selectedSeats.length * prices[selectedClass]).toFixed(2)}`;
        }
    }

    // Class selection
    document.querySelectorAll('.class-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            document.querySelectorAll('.class-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            selectedClass = this.dataset.class;
            document.getElementById('selected-class').textContent =
                selectedClass === 'second' ? 'Second' : 'First';
            generateSeats();
            updateSelectionSummary();
        });
    });

    // Confirm booking
    document.querySelector('.confirm').addEventListener('click', function () {
        if (selectedSeats.length === 0) {
            alert('Please select at least one seat.');
            return;
        }
        alert(`Booking confirmed for seats: ${selectedSeats.join(', ')}`);
    });

    // Cancel
    document.querySelector('.cancel').addEventListener('click', function () {
        if (confirm('Are you sure you want to cancel seat selection?')) {
            selectedSeats = [];
            updateSelectionSummary();
            document.querySelectorAll('.seat.selected').forEach(s => s.classList.remove('selected'));
        }
    });

    // Initialize on load
    window.onload = function () {
        generateSeats();
    };

    // Optional: Open 360 view in new tab or modal
    document.querySelector('.btn-360').addEventListener('click', function () {
        alert("Opening 360° view... (Link will be added by admin)");
        // Example: window.open("https://your-360-link.com", "_blank");
    });
</script>
</body>
<script>
// Populate booking overview from stored schedule and prepare booking flow
document.addEventListener('DOMContentLoaded', async function() {
    let selectedSchedule = null;
    try {
        const raw = localStorage.getItem('slraile_selected_schedule');
        console.log('Raw localStorage data:', raw);
        let data = raw ? JSON.parse(raw) : null;
        console.log('Parsed localStorage data:', data);
        
        const qp = new URLSearchParams(window.location.search);
        console.log('URL parameters:', qp.toString());
        
        // Always try to get data from URL parameters as primary source
        const urlData = {
            id: qp.get('id') ? Number(qp.get('id')) : null,
            trainName: qp.get('train'),
            routeFrom: qp.get('from'),
            routeTo: qp.get('to'),
            departureTime: qp.get('dep'),
            arrivalTime: qp.get('arr'),
            platform: qp.get('plat')
        };
        console.log('URL data:', urlData);
        
        // Use URL data if it has valid information, otherwise use localStorage data
        if (urlData.id || urlData.trainName) {
            data = urlData;
            console.log('Using URL data as primary source');
        } else if (data && data.trainName) {
            console.log('Using localStorage data as fallback');
        } else {
            console.warn('No valid schedule data found in localStorage or URL');
            // Show error message to user
            document.getElementById('bo-train').textContent = 'No schedule selected';
            document.getElementById('bo-route').textContent = 'Please go back and select a train';
            document.getElementById('bo-departure').textContent = '-';
            document.getElementById('bo-arrival').textContent = '-';
            document.getElementById('bo-platform').textContent = '-';
            const today = new Date();
            document.getElementById('bo-date').textContent = today.toISOString().slice(0,10);
            
            // Show alert and redirect after a delay
            alert('No train schedule selected. Redirecting to schedule page...');
            setTimeout(() => {
                window.location.href = '../../IT24102460/HTML/mem_shedule.html';
            }, 2000);
            return;
        }
        
        selectedSchedule = data;
        console.log('Final selected schedule:', selectedSchedule);
        
        if (data) {
            document.getElementById('bo-train').textContent = data.trainName || '-';
            const route = `${data.routeFrom || ''} → ${data.routeTo || ''}`.trim();
            document.getElementById('bo-route').textContent = route || '-';
            document.getElementById('bo-departure').textContent = data.departureTime || '-';
            document.getElementById('bo-arrival').textContent = data.arrivalTime || '-';
            document.getElementById('bo-platform').textContent = data.platform || '-';
            const today = new Date();
            document.getElementById('bo-date').textContent = today.toISOString().slice(0,10);
        }
    } catch (err) {
        console.error('Error loading schedule data:', err);
        // Show error message
        document.getElementById('bo-train').textContent = 'Error loading schedule';
        document.getElementById('bo-route').textContent = 'Please refresh and try again';
    }

    // Load seat configuration and render seat squares
    let firstSeats = 0, secondSeats = 0;
    try {
        const ORIGIN = (window.location.origin.startsWith('file:') || window.location.origin === 'null')
            ? 'http://localhost:8080'
            : window.location.origin;
        const resp = await fetch(`${ORIGIN}/api/admin/seats/current`);
        if (resp.ok) {
            const cfg = await resp.json();
            firstSeats = cfg.firstClassSeats || 0;
            secondSeats = cfg.secondClassSeats || 0;
        }
    } catch (err) {
        console.warn('Could not load seat configuration, using defaults:', err);
        // Use default seat counts if API fails
        firstSeats = 8; // Default first class seats
        secondSeats = 50; // Default second class seats
    }

    const seatMap = document.getElementById('seat-map');
    const classButtons = document.querySelectorAll('.class-btn');
    const selectedClassEl = document.getElementById('selected-class');

    let selectedSeats = [];
    const maxSelections = 6;

    const priceMap = (typeof prices !== 'undefined') ? prices : { second: 400, firstclass: 1200 };

    function updateSelectionSummary() {
        const list = document.getElementById('selected-seats-list');
        const priceEl = document.getElementById('total-price');
        if (!list || !priceEl) return;
        if (selectedSeats.length === 0) {
            list.innerHTML = '<p>No seats selected.</p>';
            priceEl.textContent = `Rs. 0.00`;
            return;
        }
        const ul = document.createElement('ul');
        ul.innerHTML = '';
        selectedSeats.forEach(id => {
            const li = document.createElement('li');
            li.textContent = id;
            li.onclick = () => {
                const el = seatMap.querySelector(`[data-id="${id}"]`);
                if (el) el.click();
            };
            ul.appendChild(li);
        });
        list.innerHTML = '';
        list.appendChild(ul);
        const clsKey = (selectedClassEl.textContent.toLowerCase() === 'first') ? 'firstclass' : 'second';
        const total = (selectedSeats.length * (priceMap[clsKey] || 0)).toFixed(2);
        priceEl.textContent = `Rs. ${total}`;
    }

    async function renderSeats(total) {
        seatMap.innerHTML = '';
        const seatsPerRow = 5;
        // fetch occupied seats for the day if schedule id exists
        let occupied = new Set();
        try {
            if (selectedSchedule?.id) {
                const dateStr = document.getElementById('bo-date').textContent;
                const ORIGIN = (window.location.origin.startsWith('file:') || window.location.origin === 'null')
                    ? 'http://localhost:8080'
                    : window.location.origin;
                const r = await fetch(`${ORIGIN}/api/bookings/occupied?trainScheduleId=${selectedSchedule.id}&travelDate=${dateStr}`);
                if (r.ok) {
                    const arr = await r.json();
                    occupied = new Set(arr);
                }
            }
        } catch (err) {
            console.warn('Could not load occupied seats:', err);
        }
        let rowEl = null;
        for (let i = 0; i < total; i++) {
            if (i % seatsPerRow === 0) {
                rowEl = document.createElement('div');
                rowEl.className = 'seat-row';
                seatMap.appendChild(rowEl);
            }
            const seat = document.createElement('div');
            seat.className = 'seat available';
            const clsPrefix = (selectedClassEl.textContent.toLowerCase() === 'first') ? 'F' : 'S';
            const seatId = `${clsPrefix}${i+1}`;
            seat.dataset.id = seatId;
            seat.textContent = i+1;
            if (occupied.has(seatId)) {
                seat.classList.remove('available');
                seat.classList.add('occupied');
            } else {
                seat.addEventListener('click', () => {
                    if (seat.classList.contains('occupied')) return;
                    const idx = selectedSeats.indexOf(seatId);
                    if (idx > -1) {
                        seat.classList.remove('selected');
                        selectedSeats.splice(idx, 1);
                    } else {
                        if (selectedSeats.length >= maxSelections) {
                            alert(`You can select up to ${maxSelections} seats.`);
                            return;
                        }
                        seat.classList.add('selected');
                        selectedSeats.push(seatId);
                    }
                    updateSelectionSummary();
                });
            }
            rowEl.appendChild(seat);
        }
    }

    function activateClass(cls) {
        classButtons.forEach(b => b.classList.toggle('active', b.dataset.class === cls));
        selectedClassEl.textContent = cls === 'firstclass' ? 'First' : 'Second';
        selectedSeats = [];
        updateSelectionSummary();
        renderSeats(cls === 'firstclass' ? firstSeats : secondSeats);
    }

    classButtons.forEach(btn => btn.addEventListener('click', (e) => {
        e.preventDefault();
        activateClass(btn.dataset.class);
    }));

    // initial render for second class
    activateClass('second');

    // Hook Confirm & Continue to create booking
    const confirmLink = document.querySelector('a.confirm');
    if (confirmLink) {
        confirmLink.addEventListener('click', async function(e) {
            e.preventDefault();
            
            // Debug logging
            console.log('Selected schedule:', selectedSchedule);
            console.log('Schedule ID:', selectedSchedule?.id);
            
            if (!selectedSchedule?.id) {
                alert('Missing schedule information. Please go back and select a train again.');
                console.error('No schedule ID found. Selected schedule:', selectedSchedule);
                // Redirect back to schedule page
                window.location.href = '../../IT24102460/HTML/mem_shedule.html';
                return;
            }
            if (selectedSeats.length === 0) {
                alert('Please select at least one seat.');
                return;
            }
            const dateStr = document.getElementById('bo-date').textContent;
            const clsKey = (selectedClassEl.textContent.toLowerCase() === 'first') ? 'firstclass' : 'second';
            const total = (selectedSeats.length * (priceMap[clsKey] || 0));
            // Get member email using utility function
            const memberEmail = getCurrentUserEmail() || 'test@example.com';
            console.log('Using member email:', memberEmail);
            
            // Debug user state
            if (typeof debugUserState === 'function') {
                debugUserState();
            } else {
                console.log('Available localStorage keys:', Object.keys(localStorage));
                console.log('slraile_member_email:', localStorage.getItem('slraile_member_email'));
                console.log('slraile_email:', localStorage.getItem('slraile_email'));
                console.log('user_email:', localStorage.getItem('user_email'));
            }
            
            const payload = {
                memberEmail: memberEmail,
                trainScheduleId: selectedSchedule.id,
                travelDate: dateStr,
                seatNumbers: selectedSeats.join(','),
                totalAmount: total
            };
            
            console.log('Booking payload:', payload);
            
            try {
                const ORIGIN = (window.location.origin.startsWith('file:') || window.location.origin === 'null')
                    ? 'http://localhost:8080'
                    : window.location.origin;
                
                console.log('Making booking request to:', `${ORIGIN}/api/bookings`);
                console.log('Request payload:', JSON.stringify(payload, null, 2));
                
                const res = await fetch(`${ORIGIN}/api/bookings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                console.log('Response status:', res.status);
                console.log('Response ok:', res.ok);
                
                if (!res.ok) {
                    const errorText = await res.text();
                    console.error('Error response:', errorText);
                    throw new Error(`Server error: ${res.status} - ${errorText}`);
                }
                
                const booking = await res.json();
                console.log('Booking created successfully:', booking);
                // persist for payment page
                localStorage.setItem('slraile_current_booking_id', booking.id);
                localStorage.setItem('slraile_current_booking_summary', JSON.stringify({
                    bookingId: booking.id,
                    trainName: selectedSchedule.trainName,
                    routeFrom: selectedSchedule.routeFrom,
                    routeTo: selectedSchedule.routeTo,
                    departureTime: selectedSchedule.departureTime,
                    arrivalTime: selectedSchedule.arrivalTime,
                    seatNumbers: booking.seatNumbers,
                    totalAmount: booking.totalAmount
                }));
                window.location.href = '../../IT24101558/HTML/payment.html?bookingId=' + booking.id;
            } catch (err) {
                alert('Failed to create booking: ' + err.message);
                console.error('Booking error:', err);
            }
        });
    }
});
</script>
</html>