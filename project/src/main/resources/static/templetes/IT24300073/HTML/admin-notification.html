<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Notifications - SLRailE</title>
    <link rel="stylesheet" href="../CSS/admin-notification.css">
</head>
<body>
<header class="header">
    <div class="logo-container">
        <div class="train-icon"></div>
        <h1><a href="index.html"> SLRailE </a></h1>
    </div>
    <nav class="navigation">
        <ul>
            <li><a href="../../IT24101009/HTML/admin.html">Dashboard</a></li>
            <li><a href="../../IT24102460/HTML/admin_shedule.html">Schedule</a></li>
            <li><a href="../../IT24101525/HTML/adminseatmanegement.html">Seat Allocation</a></li>
            <li><a href="../../IT24300073/HTML/admin-profile.html">My Profile</a></li>
            <li><a href="#" class="active">Notification</a></li>
            <li><a href="../../IT24101009/HTML/admin-feedback.html">Feedback</a></li>
            <li><a href="#" id="logout-link">Logout</a></li>
        </ul>
    </nav>
</header>

<main class="main-content">
    <section class="hero">
        <h1>Admin Notifications</h1>
        <p class="subtitle">Manage system notifications for users and staff</p>
    </section>

    <div class="notification-container">
        <!-- Add New Notification Form -->
        <div class="add-notification-section">
            <h3 class="section-title">Add New Notification</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label for="notification-title">Title *</label>
                    <input type="text" id="notification-title" placeholder="Enter notification title" required>
                </div>
                <div class="form-group">
                    <label for="notification-type">Type *</label>
                    <select id="notification-type" required>
                        <option value="">Select notification type</option>
                        <option value="SYSTEM">System</option>
                        <option value="ALERT">Alert</option>
                        <option value="MAINTENANCE">Maintenance</option>
                        <option value="UPDATE">Update</option>
                        <option value="INFO">Information</option>
                    </select>
                </div>
                <div class="form-group full-width">
                    <label for="notification-message">Message *</label>
                    <textarea id="notification-message" rows="4" placeholder="Enter notification message" required></textarea>
                </div>
                <div class="form-group">
                    <label for="notification-audience">Audience *</label>
                    <select id="notification-audience" required>
                        <option value="">Select audience</option>
                        <option value="ALL">All Users</option>
                        <option value="PASSENGERS">Passengers</option>
                        <option value="STAFF">Staff</option>
                        <option value="ADMINS">Administrators</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="notification-priority">Priority *</label>
                    <select id="notification-priority" required>
                        <option value="LOW">Low</option>
                        <option value="MEDIUM">Medium</option>
                        <option value="HIGH">High</option>
                        <option value="URGENT">Urgent</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="notification-expiry">Expiry Date (Optional)</label>
                    <input type="datetime-local" id="notification-expiry" placeholder="Leave empty for no expiry">
                    <small style="color: #666; font-size: 0.8em;">Leave empty if you don't want the notification to expire</small>
                </div>
            </div>
            <div class="btn-group">
                <button class="primary-btn" id="add-notification-btn">Add Notification</button>
                <button class="secondary-btn" id="clear-form-btn">Clear Form</button>
            </div>
        </div>

        <!-- Notification List -->
        <div class="notification-list-section">
            <h3 class="section-title">Current Notifications</h3>
            <div class="notification-list">
                <!-- Sample Notification 1 -->
                <div class="notification-item" data-id="1">
                    <div class="notification-header">
                        <div class="notification-title">
                            <h4>System Maintenance Scheduled</h4>
                            <span class="notification-badge status-maintenance">Maintenance</span>
                        </div>
                        <div class="notification-actions">
                            <button class="edit-btn" title="Edit notification">‚úèÔ∏è</button>
                            <button class="delete-btn" title="Delete notification">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="notification-body">
                        <p class="notification-message">Scheduled maintenance will be performed on the booking system this Saturday from 2 AM to 6 AM. Service may be temporarily unavailable during this period.</p>
                        <div class="notification-meta">
                            <span class="audience">Audience: All Users</span>
                            <span class="priority">Priority: High</span>
                            <span class="timestamp">Created: Today, 09:42 AM</span>
                            <span class="expiry">Expires: Dec 15, 2025, 6:00 AM</span>
                        </div>
                    </div>
                </div>

                <!-- Sample Notification 2 -->
                <div class="notification-item" data-id="2">
                    <div class="notification-header">
                        <div class="notification-title">
                            <h4>Mobile App Update Available</h4>
                            <span class="notification-badge status-update">Update</span>
                        </div>
                        <div class="notification-actions">
                            <button class="edit-btn" title="Edit notification">‚úèÔ∏è</button>
                            <button class="delete-btn" title="Delete notification">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="notification-body">
                        <p class="notification-message">A new version of the SLRailE mobile app is now available with improved booking features and bug fixes. Please update to enjoy the best experience.</p>
                        <div class="notification-meta">
                            <span class="audience">Audience: Passengers</span>
                            <span class="priority">Priority: Medium</span>
                            <span class="timestamp">Created: Yesterday, 3:15 PM</span>
                            <span class="expiry">Expires: Jan 1, 2026, 12:00 AM</span>
                        </div>
                    </div>
                </div>

                <!-- Sample Notification 3 -->
                <div class="notification-item" data-id="3">
                    <div class="notification-header">
                        <div class="notification-title">
                            <h4>Train Schedule Changes</h4>
                            <span class="notification-badge status-alert">Alert</span>
                        </div>
                        <div class="notification-actions">
                            <button class="edit-btn" title="Edit notification">‚úèÔ∏è</button>
                            <button class="delete-btn" title="Delete notification">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="notification-body">
                        <p class="notification-message">Due to track maintenance, several train schedules have been adjusted for routes between Colombo and Kandy from December 10-20. Please check updated schedules before traveling.</p>
                        <div class="notification-meta">
                            <span class="audience">Audience: All Users</span>
                            <span class="priority">Priority: Urgent</span>
                            <span class="timestamp">Created: Dec 5, 2025, 11:30 AM</span>
                            <span class="expiry">Expires: Dec 20, 2025, 11:59 PM</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Notification Modal (Hidden by default) -->
        <div class="modal" id="edit-notification-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Edit Notification</h3>
                    <button class="close-modal-btn">&times;</button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit-notification-id">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="edit-notification-title">Title *</label>
                            <input type="text" id="edit-notification-title" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-notification-type">Type *</label>
                            <select id="edit-notification-type" required>
                                <option value="SYSTEM">System</option>
                                <option value="ALERT">Alert</option>
                                <option value="MAINTENANCE">Maintenance</option>
                                <option value="UPDATE">Update</option>
                                <option value="INFO">Information</option>
                            </select>
                        </div>
                        <div class="form-group full-width">
                            <label for="edit-notification-message">Message *</label>
                            <textarea id="edit-notification-message" rows="4" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="edit-notification-audience">Audience *</label>
                            <select id="edit-notification-audience" required>
                                <option value="ALL">All Users</option>
                                <option value="PASSENGERS">Passengers</option>
                                <option value="STAFF">Staff</option>
                                <option value="ADMINS">Administrators</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-notification-priority">Priority *</label>
                            <select id="edit-notification-priority" required>
                                <option value="LOW">Low</option>
                                <option value="MEDIUM">Medium</option>
                                <option value="HIGH">High</option>
                                <option value="URGENT">Urgent</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-notification-expiry">Expiry Date</label>
                            <input type="datetime-local" id="edit-notification-expiry">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="secondary-btn close-modal">Cancel</button>
                    <button class="primary-btn" id="save-notification-btn">Save Changes</button>
                </div>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div class="modal" id="delete-confirmation-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Confirm Deletion</h3>
                    <button class="close-modal-btn">&times;</button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this notification? This action cannot be undone.</p>
                    <input type="hidden" id="delete-notification-id">
                </div>
                <div class="modal-footer">
                    <button class="secondary-btn close-modal">Cancel</button>
                    <button class="danger-btn" id="confirm-delete-btn">Delete Notification</button>
                </div>
            </div>
        </div>
    </div>
</main>

<footer class="footer">
    <div class="footer-content">
        <div class="footer-logo">
            <h3>SLRailE</h3>
            <p>SLRailE is your all-in-one digital companion for train travel across Sri Lanka. Designed to make journeys smoother and more convenient, SLRailE provides real-time train schedules, route planning, and live updates on arrivals, departures, and delays.</p>
            <p>Whether you're a daily commuter or a tourist exploring the island's breathtaking scenery, SLRailE is your essential partner for smart and seamless railway travel.</p>
        </div>
        <div class="footer-links">
            <div class="link-column">
                <h4>Admin Tools</h4>
                <ul>
                    <li><a href="#">Dashboard</a></li>
                    <li><a href="#">Schedule</a></li>
                    <li><a href="#">Feedback</a></li>
                    <li><a href="#">Seat Allocation</a></li>
                    <li><a href="#">Profile</a></li>
                </ul>
            </div>
            <div class="link-column">
                <h4>Information</h4>
                <ul>
                    <li><a href="#">About Us</a></li>
                    <li><a href="#">Careers</a></li>
                    <li><a href="#">News</a></li>
                    <li><a href="#">Contact</a></li>
                </ul>
            </div>
            <div class="link-column">
                <h4>Legal</h4>
                <ul>
                    <li><a href="#">Privacy Policy</a></li>
                    <li><a href="#">Terms of Service</a></li>
                    <li><a href="#">Cookie Policy</a></li>
                </ul>
            </div>
        </div>
    </div>
    <div class="copyright">
        <p>&copy; 2025 SLRailE. All rights reserved.</p>
    </div>
</footer>

<script>
    // API Base URL
    const API_BASE_URL = 'http://localhost:8080/api/admin/notifications';
    
    // Load notifications on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadNotifications();
        setupEventListeners();
    });

    // Load all notifications from API
    async function loadNotifications() {
        try {
            const response = await fetch(API_BASE_URL);
            if (response.ok) {
                const notifications = await response.json();
                displayNotifications(notifications);
            } else {
                console.error('Failed to load notifications');
                showMessage('Failed to load notifications', 'error');
            }
        } catch (error) {
            console.error('Error loading notifications:', error);
            showMessage('Error loading notifications', 'error');
        }
    }

    // Display notifications in the UI
    function displayNotifications(notifications) {
        const notificationList = document.querySelector('.notification-list');
        notificationList.innerHTML = '';

        if (notifications.length === 0) {
            notificationList.innerHTML = '<p class="no-notifications">No notifications found.</p>';
            return;
        }

        notifications.forEach(notification => {
            const notificationElement = createNotificationElement(notification);
            notificationList.appendChild(notificationElement);
        });
    }

    // Create notification element
    function createNotificationElement(notification) {
        const div = document.createElement('div');
        div.className = 'notification-item';
        div.dataset.id = notification.id;

        // Format dates
        const createdAt = new Date(notification.createdAt).toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric',
            hour: 'numeric',
            minute: '2-digit'
        });

            let expiryText = 'Never';
        if (notification.expiresAt) {
            const expiryDate = new Date(notification.expiresAt);
                expiryText = expiryDate.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit'
                });
            }

            // Format audience for display
        let audienceText = notification.audience.charAt(0).toUpperCase() + notification.audience.slice(1);
        if (notification.audience === 'ALL') audienceText = 'All Users';

        div.innerHTML = `
                <div class="notification-header">
                    <div class="notification-title">
                    <h4>${notification.title}</h4>
                    <span class="notification-badge status-${notification.type.toLowerCase()}">${notification.type}</span>
                    </div>
                    <div class="notification-actions">
                        <button class="edit-btn" title="Edit notification">‚úèÔ∏è</button>
                        <button class="delete-btn" title="Delete notification">üóëÔ∏è</button>
                    </div>
                </div>
                <div class="notification-body">
                <p class="notification-message">${notification.message}</p>
                    <div class="notification-meta">
                        <span class="audience">Audience: ${audienceText}</span>
                    <span class="priority">Priority: ${notification.priority}</span>
                    <span class="timestamp">Created: ${createdAt}</span>
                        <span class="expiry">Expires: ${expiryText}</span>
                    </div>
                </div>
            `;

        return div;
    }

    // Setup event listeners
    function setupEventListeners() {
        // Clear form button
        document.getElementById('clear-form-btn').addEventListener('click', clearForm);

        // Add notification button
        document.getElementById('add-notification-btn').addEventListener('click', addNotification);

        // Save edited notification button
        document.getElementById('save-notification-btn').addEventListener('click', saveNotification);

        // Confirm delete button
        document.getElementById('confirm-delete-btn').addEventListener('click', confirmDelete);

        // Close modal buttons
        document.querySelectorAll('.close-modal-btn, .close-modal').forEach(button => {
            button.addEventListener('click', closeModals);
        });

        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            const editModal = document.getElementById('edit-notification-modal');
            const deleteModal = document.getElementById('delete-confirmation-modal');

            if (event.target === editModal) {
                editModal.style.display = 'none';
            }
            if (event.target === deleteModal) {
                deleteModal.style.display = 'none';
            }
        });

        // Delegate event listeners for dynamic content
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('edit-btn')) {
                editNotification(event.target);
            } else if (event.target.classList.contains('delete-btn')) {
                deleteNotification(event.target);
            }
        });
    }

    // Clear form
    function clearForm() {
        document.getElementById('notification-title').value = '';
        document.getElementById('notification-type').value = '';
        document.getElementById('notification-message').value = '';
        document.getElementById('notification-audience').value = '';
        document.getElementById('notification-priority').value = 'MEDIUM';
        document.getElementById('notification-expiry').value = '';
    }

    // Add new notification
    async function addNotification() {
        const title = document.getElementById('notification-title').value;
        const type = document.getElementById('notification-type').value;
        const message = document.getElementById('notification-message').value;
        const audience = document.getElementById('notification-audience').value;
        const priority = document.getElementById('notification-priority').value;
        const expiry = document.getElementById('notification-expiry').value;

        if (!title || !type || !message || !audience) {
            showMessage('Please fill in all required fields', 'error');
            return;
        }

        const notificationData = {
            title: title,
            message: message,
            type: type,
            audience: audience,
            priority: priority,
            expiresAt: expiry ? new Date(expiry).toISOString() : null
        };
        
        console.log('DEBUG: Notification data being sent:', notificationData);
        console.log('DEBUG: Expiry date:', expiry);
        console.log('DEBUG: Current time:', new Date().toISOString());

        try {
            const response = await fetch(API_BASE_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(notificationData)
            });

            if (response.ok) {
                showMessage('Notification added successfully!', 'success');
                clearForm();
                loadNotifications(); // Reload the list
            } else {
                showMessage('Failed to add notification', 'error');
            }
        } catch (error) {
            console.error('Error adding notification:', error);
            showMessage('Error adding notification', 'error');
        }
    }

    // Edit notification
    function editNotification(button) {
        const notificationItem = button.closest('.notification-item');
        const id = notificationItem.dataset.id;
        
        // Find the notification data (you might want to store this in a data attribute)
        const title = notificationItem.querySelector('h4').textContent;
        const type = notificationItem.querySelector('.notification-badge').textContent;
        const message = notificationItem.querySelector('.notification-message').textContent;
        const audience = notificationItem.querySelector('.audience').textContent.replace('Audience: ', '');
        const priority = notificationItem.querySelector('.priority').textContent.replace('Priority: ', '');

        // Set values in edit modal
        document.getElementById('edit-notification-id').value = id;
        document.getElementById('edit-notification-title').value = title;
        document.getElementById('edit-notification-type').value = type;
        document.getElementById('edit-notification-message').value = message;
        document.getElementById('edit-notification-audience').value = audience === 'All Users' ? 'ALL' : audience.toUpperCase();
        document.getElementById('edit-notification-priority').value = priority.toUpperCase();

        // Show modal
        document.getElementById('edit-notification-modal').style.display = 'block';
    }

    // Save edited notification
    async function saveNotification() {
        const id = document.getElementById('edit-notification-id').value;
        const title = document.getElementById('edit-notification-title').value;
        const type = document.getElementById('edit-notification-type').value;
        const message = document.getElementById('edit-notification-message').value;
        const audience = document.getElementById('edit-notification-audience').value;
        const priority = document.getElementById('edit-notification-priority').value;
        const expiry = document.getElementById('edit-notification-expiry').value;

        if (!title || !type || !message || !audience) {
            showMessage('Please fill in all required fields', 'error');
            return;
        }

        const notificationData = {
            title: title,
            message: message,
            type: type,
            audience: audience,
            priority: priority,
            expiresAt: expiry ? new Date(expiry).toISOString() : null
        };

        try {
            const response = await fetch(`${API_BASE_URL}/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(notificationData)
            });

            if (response.ok) {
                showMessage('Notification updated successfully!', 'success');
                closeModals();
                loadNotifications(); // Reload the list
            } else {
                showMessage('Failed to update notification', 'error');
            }
        } catch (error) {
            console.error('Error updating notification:', error);
            showMessage('Error updating notification', 'error');
        }
    }

    // Delete notification
    function deleteNotification(button) {
        const notificationItem = button.closest('.notification-item');
        const id = notificationItem.dataset.id;

        document.getElementById('delete-notification-id').value = id;
        document.getElementById('delete-confirmation-modal').style.display = 'block';
    }

    // Confirm delete
    async function confirmDelete() {
        const id = document.getElementById('delete-notification-id').value;

        try {
            const response = await fetch(`${API_BASE_URL}/${id}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showMessage('Notification deleted successfully!', 'success');
                closeModals();
                loadNotifications(); // Reload the list
            } else {
                showMessage('Failed to delete notification', 'error');
            }
        } catch (error) {
            console.error('Error deleting notification:', error);
            showMessage('Error deleting notification', 'error');
        }
    }

    // Close modals
    function closeModals() {
        document.getElementById('edit-notification-modal').style.display = 'none';
        document.getElementById('delete-confirmation-modal').style.display = 'none';
    }

    // Show message (you can implement a better toast notification system)
    function showMessage(message, type) {
        // Simple alert for now - you can replace with a better notification system
        alert(message);
    }

    // Logout handler
    document.getElementById('logout-link')?.addEventListener('click', function(e){
        e.preventDefault();
        try {
            localStorage.removeItem('slraile_email');
            localStorage.clear();
        } catch(_e) {}
        window.location.href='../../IT24101208/HTML/Login.html';
    });
</script>
</body>
</html>